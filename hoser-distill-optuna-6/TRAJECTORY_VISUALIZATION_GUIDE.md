# Trajectory Visualization Guide

This guide explains how to use the modular trajectory visualization system for HOSER evaluation.

## Overview

The `visualize_trajectories.py` script provides a flexible, extensible system for visualizing generated trajectories on maps. It supports multiple sampling strategies, comparison modes, and output formats suitable for research papers and presentations.

## Quick Start

### Basic Usage (Length-based Sampling)

```bash
cd hoser-distill-optuna-6
uv run python visualize_trajectories.py
```

This generates:
- **Separate plots**: Short, medium, long trajectories for each model/OD type
- **Overlaid plots**: All three lengths on one map for comparison

Output: `figures/trajectories/` with both PDF and PNG formats

## Sampling Strategies

### 1. Length-based (Default)

Samples trajectories at 25th, 50th, and 75th percentiles:

```bash
uv run python visualize_trajectories.py --sample_strategy length_based
```

**Use case**: Show variety in trajectory lengths (short, medium, long trips)

### 2. Random Sampling

Randomly select trajectories:

```bash
uv run python visualize_trajectories.py --sample_strategy random --samples_per_type 3
```

**Use case**: Show general variety without length bias

### 3. Representative (Median)

Sample median-length trajectories:

```bash
uv run python visualize_trajectories.py --sample_strategy representative
```

**Use case**: Show most typical/representative trajectories

## Output Modes

### Separate Plots Only

```bash
uv run python visualize_trajectories.py --no_overlaid
```

Generates individual plots for each trajectory.

### Overlaid Plots Only

```bash
uv run python visualize_trajectories.py --no_separate
```

Generates comparison plots with all trajectories on one map.

### Cross-Model Comparison (Same OD Pairs)

```bash
uv run python visualize_trajectories.py --cross_model --no_separate --no_overlaid
```

**NEW**: Compares all models (vanilla, distilled, distilled_seed44, and **real trajectories**) for the **same origin-destination pairs**. This shows how each model routes the same trip, with start and end points aligned.

**Features:**
- Finds OD pairs that appear in all models including real data
- Samples short, medium, and long trips
- Color-coded by model (vanilla=red, distilled=blue, distilled_seed44=green, real=gold/dashed)
- Clear visualization of routing differences

**Output:** `figures/trajectories/cross_model/`

### Both (Default)

Both separate and overlaid plots are generated by default.

## Basemap Options

### No Basemap (Default - Fastest)

```bash
uv run python visualize_trajectories.py --basemap_style none
```

Simple plot with trajectory lines only. **Recommended for speed.**

### Gaode Maps (China-Friendly)

```bash
uv run python visualize_trajectories.py --basemap_style gaode
```

Uses Gaode (高德) map tiles, which work well in China. **Recommended for users in China.**

### CartoDB (Alternative)

```bash
uv run python visualize_trajectories.py --basemap_style cartodb
```

CartoDB Positron style, often accessible in China.

### OpenStreetMap

```bash
uv run python visualize_trajectories.py --basemap_style osm
```

Standard OpenStreetMap tiles. **May be slow or blocked in China.**

### Adjusting Timeout

If basemap requests are timing out:

```bash
uv run python visualize_trajectories.py --basemap_style gaode --basemap_timeout 10
```

Default timeout is 5 seconds. Increase if needed for slow connections.

## Advanced Options

### Custom Output Directory

```bash
uv run python visualize_trajectories.py --output_dir my_custom_figures
```

### High Resolution Output

```bash
uv run python visualize_trajectories.py --dpi 600
```

### Custom Random Seed

```bash
uv run python visualize_trajectories.py --random_seed 123
```

## Complete Example

```bash
# Generate random samples with OSM basemap at high resolution
uv run python visualize_trajectories.py \
    --sample_strategy random \
    --samples_per_type 5 \
    --basemap_style osm \
    --dpi 600 \
    --output_dir figures/high_res_trajectories \
    --random_seed 42
```

## Architecture

### Modular Components

1. **VisualizationConfig**: Centralized configuration
2. **RoadNetworkLoader**: Loads and caches road network GPS data
3. **TrajectoryLoader**: Loads trajectories from CSV files
4. **TrajectorySampler**: Implements sampling strategies
5. **TrajectoryPlotter**: Creates visualizations
6. **TrajectoryVisualizer**: Orchestrates the pipeline

### Extending the System

#### Add New Sampling Strategy

Edit `visualize_trajectories.py`:

```python
class TrajectorySampler:
    def sample_custom(self, trajectories: List[Trajectory]) -> Dict[str, Trajectory]:
        """Your custom sampling logic"""
        # Example: Sample by time of day
        morning = [t for t in trajectories if is_morning(t)]
        evening = [t for t in trajectories if is_evening(t)]
        return {
            "morning": random.choice(morning),
            "evening": random.choice(evening)
        }
```

Then use:
```python
config.sample_strategy = "custom"
```

#### Add New Plot Type

```python
class TrajectoryPlotter:
    def plot_grid_comparison(self, trajectories: Dict[str, Trajectory]):
        """Create 3x3 grid showing all models"""
        fig, axes = plt.subplots(3, 3, figsize=(18, 18))
        # Your plotting logic...
```

## Output Files

### File Naming

**Separate plots:**
- Format: `{model}_{od_type}_{length}.{pdf,png}`
- Example: `distilled_train_short.pdf`

**Overlaid plots:**
- Format: `{model}_{od_type}_all.{pdf,png}`
- Example: `distilled_seed44_test_all.png`

### Directory Structure

```
figures/trajectories/
├── separate/
│   ├── distilled_train_short.{pdf,png}
│   ├── distilled_train_medium.{pdf,png}
│   ├── distilled_train_long.{pdf,png}
│   └── ... (36 files total)
├── overlaid/
│   ├── distilled_train_all.{pdf,png}
│   ├── distilled_test_all.{pdf,png}
│   └── ... (12 files total)
└── cross_model/
    ├── train_od_comparison_1_origin{X}_dest{Y}.{pdf,png}
    ├── test_od_comparison_1_origin{X}_dest{Y}.{pdf,png}
    └── ... (variable, based on common OD pairs found)
```

## Performance Tips

1. **Disable basemap for speed**: Use `--basemap_style none` (default)
2. **Reduce samples**: Use `--samples_per_type 1` for quick previews
3. **Skip overlaid plots**: Use `--no_overlaid` to halve generation time

## Visualization Features

Each plot includes:
- **Trajectory line**: Main path visualization
- **Start marker**: Green circle at origin
- **End marker**: Red square at destination
- **Legend**: Clear labeling of elements
- **Auto-zoom**: Automatic framing with padding
- **Grid**: Coordinate grid for reference

## Use Cases

### For Markdown Notes

Use PNG files for better compatibility:
```markdown
![Distilled Train Medium](figures/trajectories/separate/distilled_train_medium.png)
```

### For Research Papers

Use PDF files for vector graphics quality:
```latex
\includegraphics{figures/trajectories/separate/distilled_train_medium.pdf}
```

### For Presentations

Use high-DPI PNG files:
```bash
uv run python visualize_trajectories.py --dpi 600 --basemap_style osm
```

## Troubleshooting

### Network Errors with OSM Basemap

If you see "Network is unreachable" errors:
- Use `--basemap_style none` (default)
- Or ensure internet connection is available

### Memory Issues

If processing fails with large datasets:
- Reduce `samples_per_type`
- Process models individually by modifying the script

### Missing Trajectories

If certain models aren't found:
- Check that CSV files in `gene/Beijing/seed42/` follow naming convention
- Files should contain model name (distilled/vanilla) and OD type (train/test)

## Performance Benchmarks

On a typical system:
- **Road network loading**: ~2 seconds
- **Per model processing**: ~5 seconds
- **Total time (all models)**: ~30 seconds
- **With OSM basemap**: ~5 minutes (network-dependent)

## Dependencies

Automatically installed via `uv`:
- `matplotlib`: Plotting library
- `contextily`: OpenStreetMap basemap tiles
- `geopandas`: Geospatial data handling
- `polars`: Fast CSV parsing
- `numpy`: Numerical operations

## Support

For issues or questions:
1. Check linter output: `uv tool run ruff check visualize_trajectories.py`
2. Review log messages for specific errors
3. Verify input data paths in configuration

