---
alwaysApply: true
---

# Worktree Multi-Agent Coordination Rules

## üö® CRITICAL: RUN SETUP BEFORE DOING ANYTHING üö®

**IF YOU JUST CREATED A WORKTREE, RUN THIS COMMAND IMMEDIATELY:**

```bash
cd your-worktree
bash .cursor/setup-worktree-unix.sh
```

**This script will:**
- ‚è≥ Wait for Cursor's automatic setup to complete (if still running)
- üöÄ Run setup if not started yet (handles timing automatically)
- ‚ö° Skip instantly if already complete (idempotent - safe to run multiple times)
- ‚úÖ Verify everything is ready
- ü§ñ Display your agent ID

**Output you'll see:**

If setup already complete:
```
‚úÖ Worktree setup already complete (skipping re-run)
Verification:
  ‚úÖ Symlink exists
  ‚úÖ Agent ID: PdPfi
  ‚úÖ Virtual environment exists
```

If setup needs to run:
```
üîß Setting up worktree environment...
üì¶ Syncing dependencies with uv...
üîó Setting up .cursor/plans symlink...
ü§ñ Assigning agent ID...
‚úÖ Worktree setup complete!
```

---

## Critical: Worktree Environment Detection

Before doing ANY work, check if you're in a worktree:

```bash
# Check if .cursor/plans/ is a symlink
ls -la .cursor/plans/
```

If `.cursor/plans/` is a **symlink**, you are in an agent worktree and MUST follow these rules.

## Why Setup Takes Time

Cursor automatically runs `.cursor/setup-worktree-unix.sh` when creating worktrees. This script:

1. Syncs dependencies with `uv sync` (~30 seconds)
2. Creates `.cursor/plans` symlink to root repository
3. Assigns unique agent ID
4. Logs everything to `.cursor/worktree-setup.log`

**Timeline:** Cursor queues setup T+30s to T+3m after creation, then script runs ~30s = Total 1-4 minutes

## Multi-Agent Plan Coordination

### Reading the Shared Plan

**ALWAYS** read `.cursor/plans/*.plan.md` before starting work:

1. Check which tasks are marked `[ ]` (available)
2. Check which tasks are `[IN PROGRESS - AgentX - Date]` (being worked on)
3. Check dependencies in the task description
4. Choose an available task that has no blocking dependencies

### Claiming a Task

When you start working on a task:

1. **Get your agent ID** (assigned during worktree setup):
   ```bash
   AGENT_ID=$(cat .cursor/worktree-agent-id)
   echo "My agent ID: $AGENT_ID"
   ```

2. **EDIT and SAVE the plan file** to mark task as IN PROGRESS:
   ```markdown
   ### Task X.Y: Task Name [IN PROGRESS - <YOUR_AGENT_ID> - 2025-11-02 14:30]
   ```
   Replace `<YOUR_AGENT_ID>` with the ID from step 1 (e.g., "PdPfi", "H7WqM")

3. **Verify update is saved** (changes are instant via symlink):
   ```bash
   cat .cursor/plans/*.plan.md | grep "Task X.Y"
   # Should show: [IN PROGRESS - <YOUR_AGENT_ID> - timestamp]
   ```

4. **DO NOT commit the plan from worktrees** - it's a symlink, not in git

5. **Start working** on the task code

### Updating Progress

As you complete subtasks:

```markdown
- [x] Completed subtask description
- [ ] Not yet completed subtask
```

**Save frequently** - other agents can see your progress in real-time.

### Completing a Task

**CRITICAL WORKFLOW** - Do these steps IN ORDER:

1. **Get your agent ID**:
   ```bash
   AGENT_ID=$(cat .cursor/worktree-agent-id)
   ```

2. **EDIT and SAVE the plan file** to mark task as DONE:
   ```markdown
   ### Task X.Y: Task Name [DONE - <YOUR_AGENT_ID> - 2025-11-02 15:45]
   ```
   Use your agent ID from step 1 (e.g., "PdPfi", "H7WqM")

3. **Verify plan update saved**:
   ```bash
   cat .cursor/plans/*.plan.md | grep "Task X.Y"
   # Should show: [DONE - <YOUR_AGENT_ID> - timestamp]
   ```

4. **THEN commit your CODE changes**:
   ```bash
   git add python_pipeline.py config/ tools/
   git commit -m "‚ú® feat: implement task X.Y - description"
   git push origin your-branch-name
   ```

5. **DO NOT commit** `.cursor/plans/` - it's a symlink, not in git

**Why this order matters:** Other agents check the plan to see what's available. If you commit code but don't update the plan, they might start duplicate work!

## Git Workflow in Worktrees

### What TO Commit

‚úÖ **Commit from your worktree:**
- Code changes (`.py` files)
- Configuration files (`.yaml` files)
- New tools or scripts
- Tests
- Documentation updates

### What NOT to Commit

‚ùå **NEVER commit from worktrees:**
- `.cursor/plans/` directory (it's a symlink)
- Other agents' working directories
- Shared output directories (`eval/`, `gene/`, `scenarios/`)

### Commit Commands

```bash
# Review your changes
git status
git diff

# Stage ONLY your code changes
git add config/new_config.yaml
git add tools/new_tool.py

# Commit with proper message
git commit -m "‚ú® feat: add new feature implementation"

# Push to your feature branch
git push origin feat/phase-name
```

## Task Dependencies

**ALWAYS** check task dependencies before starting:

- ‚úÖ **Can start**: Task dependencies are completed (`[DONE]`)
- ‚è∏Ô∏è **Wait**: Task dependencies are in progress (`[IN PROGRESS]`)
- üö´ **Blocked**: Task dependencies not started

Example:
```markdown
### Task 2.1: Implement Core Detection Module [ ]
**Dependencies:** Task 1.4 (abnormal config)
```

If Task 1.4 is not `[DONE]`, **DO NOT** start Task 2.1. Choose another available task.

## Parallel Work Guidelines

### Safe to Work in Parallel

‚úÖ Tasks that create **different files**:
- Agent1: `config/dataset_a.yaml` (new file)
- Agent2: `config/dataset_b.yaml` (new file)
- Agent3: `tools/new_tool.py` (new file)

### NOT Safe to Work in Parallel

‚ùå Tasks that modify **the same file**:
- Multiple agents editing `main_module.py`
- Multiple agents editing `core_pipeline.py`

**Rule**: Only ONE agent should work on a single file at a time.

## File Conflict Prevention

### Before Editing a File

1. Check the plan to see if another agent is working on tasks that touch this file
2. If unclear, add a note to the plan:
   ```markdown
   **Agent1 Note**: Currently editing python_pipeline.py lines 76-126 for Task 3.1
   ```

### Merge Strategy

When your task is complete:

1. Push your feature branch
2. If working on shared files (like `python_pipeline.py`), coordinate merges sequentially
3. Pull and test after other agents merge related changes

## Worktree-Specific Commands

### Environment Activation

```bash
# Already handled by worktree setup
# Each worktree has isolated .venv/ from `uv sync`

# Run commands with uv
uv run python script.py
uv run pytest tests/
uv tool run ruff check .
```

### Verifying Setup

```bash
# Check symlink is working
ls -la .cursor/plans/  # Should show symlink to root worktree

# Check environment is isolated
which python  # Should point to .venv in your worktree

# Check dependencies installed
uv run python -c "print('Environment ready!')"
```

## Communication Through Plan

### Adding Notes

Add notes to task sections for important decisions:

```markdown
### Task 2.1: Implement Core Detection Module [IN PROGRESS - Agent3 - 2025-11-02 15:00]

**Agent3 Note**: Using z-score threshold of 2.5 as specified in config.
Implemented calculate_speed_profile() with haversine distance calculation.
```

### Blocking Issues

If blocked, update task status:

```markdown
### Task 3.2: Add Cross-Dataset Validation [BLOCKED - Missing BJUT dataset symlink]

**Agent4 Note**: Waiting for Task 1.1 to complete. Dataset path doesn't exist yet.
```

## Quick Validation Commands

Before claiming task:
```bash
grep "Task X.Y:" .cursor/plans/*.plan.md | head -1
```

Before editing file:
```bash
grep "filename.py" .cursor/plans/*.plan.md | grep "IN PROGRESS"
```

Before committing:
```bash
git status && uv tool run ruff check .
```

Before merging:
```bash
uv tool run ruff check . && uv run pytest
```

## Worktree Verification and Waiting for Setup

**CRITICAL**: After creating a worktree, **WAIT** for automatic setup to complete (1-4 minutes).

### Wait for Setup to Complete

```bash
# 1. WAIT - Check if setup is running or completed
cd worktree-path

# Option A: Watch setup in real-time (recommended)
tail -f .cursor/worktree-setup.log
# Press Ctrl+C when you see "‚úÖ Worktree setup complete!"

# Option B: Wait 4 minutes, then verify
sleep 240 && ls -la .cursor/plans/

# Option C: Poll until symlink appears
while [ ! -L .cursor/plans ]; do 
  echo "Waiting for setup..."; 
  sleep 10; 
done && echo "‚úÖ Setup complete!"
```

### Verify Setup Completed Successfully

```bash
# 1. Check symlink was created by setup script
ls -la .cursor/plans/  # Should be symlink to root repo

# 2. Check your unique agent ID (use this in plan updates)
cat .cursor/worktree-agent-id  # e.g., "PdPfi" or "H7WqM"

# 3. Verify symlink target
readlink .cursor/plans/

# 4. Check setup log for any issues
tail -20 .cursor/worktree-setup.log

# 5. Check dependencies installed
uv run python -c "print('OK')"

# 6. Check you're on correct branch
git branch --show-current

# 7. Check parent commits
git log --oneline -5
```

### If You See Errors

Check the setup log:

```bash
cat .cursor/worktree-setup.log
```

To force re-run setup:

```bash
rm .cursor/.setup-complete
bash .cursor/setup-worktree-unix.sh
```

## Troubleshooting Worktree Setup

If `.cursor/plans` symlink is missing:

**Check Cursor's setup output:**
- Open "Output" panel (View ‚Üí Output)
- Select "Worktrees Setup" from dropdown
- Look for errors during worktree creation

**Check setup log in worktree:**
```bash
cat .cursor/worktree-setup.log
```

**Manually run setup script:**
```bash
cd worktree-path
bash .cursor/setup-worktree-unix.sh
```

**Verify configuration:**
```bash
# Check worktrees.json exists
cat .cursor/worktrees.json

# Check setup script exists
ls -la .cursor/setup-worktree-unix.sh
```

If issues persist, contact the user or check the root repository's `.cursor/` configuration.

## Troubleshooting Plan File Synchronization

### Issue: Plan updates not visible across agents

**Symptom**: Agent updates plan in worktree, but other agents/root don't see changes

**Cause**: Cursor file buffer caching - the editor caches file contents and doesn't auto-reload

**Solution**:

1. **Verify symlink is working** (files should be identical):
```bash
# Check symlink exists
ls -la .cursor/plans/

# Verify same inode (proves it's the same file)
stat -L .cursor/plans/*.plan.md | grep Inode
stat -L /path/to/root/.cursor/plans/*.plan.md | grep Inode

# Diff should show no differences
diff .cursor/plans/*.plan.md /path/to/root/.cursor/plans/*.plan.md
```

2. **Force Cursor to reload** the plan file:
   - **Close the file** in all worktree windows
   - **Reopen it** - Cursor will read from disk
   - Or use **"Revert File"** command (Ctrl+K R)
   - Or **restart Cursor** in that worktree

3. **Best practice for agents**:
   - Always **close plan file** after updating
   - **Reopen** before reading to get latest changes
   - Use command line to verify: `cat .cursor/plans/*.plan.md | grep "Task X.Y"`

### Verification Commands

```bash
# Verify symlink is working (in worktree)
readlink .cursor/plans/  # Should point to root repo

# Check if file is same as root
diff -q .cursor/plans/*.plan.md $(readlink .cursor/plans/)/*.plan.md && echo "‚úì Symlink working"

# Force read from disk (bypasses editor cache)
cat .cursor/plans/*.plan.md | grep "IN PROGRESS"
```

**Remember**: The symlink works at the **filesystem level**. Cursor's editor needs to be told to reload the file from disk.

## Example Workflow

### Agent Starting Work

```bash
# 1. In your worktree
cd /path/to/PROJECT-worktree

# 2. Read the plan
cat .cursor/plans/*.plan.md

# 3. Find available task (e.g., Task 1.2)

# 4. Update plan status to [IN PROGRESS - Agent1 - Date]
# (Edit and save the plan file)

# 5. Start working on subtasks
# - Create or modify files as specified in task
# - Check subtasks as complete in plan

# 6. Test your changes
uv tool run ruff check .

# 7. Commit your code
git add changed_files
git commit -m "‚ú® feat: implement task X.Y"

# 8. Mark task as DONE in plan
# (Edit and save the plan file)

# 9. Push your branch
git push origin feat/phase-name
```

## Merge Strategy and Cleanup

### Incremental Merge Strategy

Merge by phase, not all at once:

1. Complete Phase 1 ‚Üí merge to main ‚Üí test
2. Complete Phase 2 ‚Üí merge to main ‚Üí test
3. Continue phase by phase

**Benefits:**
- Catch bugs earlier (integration testing after each phase)
- Cleaner git history (logical commits grouped by phase)
- Easier rollback if needed (can revert single phase)
- Other agents can start next phase while previous merges

### Pre-Merge Checklist

Before merging your phase to main:

- [ ] All tasks in phase marked [DONE]
- [ ] All code committed and pushed
- [ ] Linting passes: `uv tool run ruff check .`
- [ ] Tests pass: `uv run pytest`
- [ ] Plan status summary updated
- [ ] No uncommitted changes: `git status`
- [ ] Reviewed changes: `git log --oneline main..HEAD`

### Merge Commands

```bash
# 1. From your worktree, switch to main
git checkout main
git pull origin main

# 2. Merge your phase branch (no fast-forward for clear history)
git merge feat/phase2-detection --no-ff -m "Merge phase 2: detection module

- Implemented core detection algorithms
- Added CLI wrapper
- All tests passing"

# 3. Push to origin
git push origin main

# 4. Return to feature branch for continued work
git checkout feat/phase2-detection
```

### Cleanup After Project Completion

```bash
# 1. List all worktrees
git worktree list

# 2. Remove each worktree (--force handles untracked files)
git worktree remove --force /path/to/PROJECT-phase1-config

# 3. Delete merged branches
git branch -d feat/phase1-config

# 4. Or force delete if has alternate commits
git branch -D feat/phase1-config

# 5. Verify cleanup
git worktree list  # Should only show main worktree
git branch | wc -l  # Check branch count
```

## Rules Summary

1. ‚úÖ **ALWAYS** run `bash .cursor/setup-worktree-unix.sh` immediately after creating worktree
2. ‚úÖ **ALWAYS** read the plan before starting work
3. ‚úÖ **ALWAYS** update task status with YOUR agent ID when starting/completing tasks
4. ‚úÖ **ALWAYS** save the plan file (changes are instant via symlink)
5. ‚ùå **NEVER** commit `.cursor/plans/` from worktrees (it's a symlink)
6. ‚úÖ **ONLY** commit your code changes from your worktree branch
7. ‚úÖ **ALWAYS** check task dependencies before starting
8. ‚úÖ **ALWAYS** verify no other agent is editing the same file
9. ‚úÖ **ALWAYS** use `uv run` for Python commands
10. ‚úÖ **ALWAYS** follow git commit message conventions with gitmojis
11. ‚ùå **NEVER** force push or modify other agents' branches
12. ‚úÖ **ALWAYS** merge incrementally by phase (not all at once)
