---
alwaysApply: true
---

# Worktree Multi-Agent Coordination Rules

## Critical: Worktree Environment Detection

Before doing ANY work, check if you're in a worktree:

```bash
# Check if .cursor/plans/ is a symlink
ls -la .cursor/plans/
```

If `.cursor/plans/` is a **symlink**, you are in an agent worktree and MUST follow these rules.

## Automatic Worktree Setup

Cursor automatically runs `.cursor/setup-worktree-unix.sh` when creating worktrees (configured via `.cursor/worktrees.json`). This script:

1. Syncs dependencies with `uv sync`
2. Creates `.cursor/plans` symlink to root repository
3. Logs setup to `.cursor/worktree-setup.log`

**‚è±Ô∏è Important: Setup delay is 1-4 minutes after worktree creation**

- Cursor queues setup execution (not immediate)
- Check `.cursor/worktree-setup.log` to verify completion
- If symlink is missing after 5 minutes, run setup manually

**No manual setup required** - but allow time for automatic setup to complete.

## Multi-Agent Plan Coordination

### Reading the Shared Plan

**ALWAYS** read `.cursor/plans/*.plan.md` before starting work:

1. Check which tasks are marked `[ ]` (available)
2. Check which tasks are `[IN PROGRESS - AgentX - Date]` (being worked on)
3. Check dependencies in the task description
4. Choose an available task that has no blocking dependencies

### Claiming a Task

When you start working on a task:

1. **Update the plan file** with your status:
   ```markdown
   ### Task X.Y: Task Name [IN PROGRESS - Agent1 - 2025-11-02 14:30]
   ```

2. **Save the file** (other agents see it instantly via symlink)

3. **DO NOT commit the plan from worktrees** - it's a symlink, commits should only be from root

4. **Start working** on the task subtasks

### Updating Progress

As you complete subtasks:

```markdown
- [x] Completed subtask description
- [ ] Not yet completed subtask
```

**Save frequently** - other agents can see your progress in real-time.

### Completing a Task

When finished:

1. **Mark task as done**:
   ```markdown
   ### Task X.Y: Task Name [DONE - Agent1 - 2025-11-02 15:45]
   ```

2. **Commit your CODE changes**:
   ```bash
   git add config/ tools/ python_pipeline.py
   git commit -m "‚ú® feat: implement task X.Y - description"
   ```

3. **DO NOT commit** `.cursor/plans/` from worktrees

## Git Workflow in Worktrees

### What TO Commit

‚úÖ **Commit from your worktree:**
- Code changes (`.py` files)
- Configuration files (`.yaml` files)
- New tools or scripts
- Tests
- Documentation updates

### What NOT to Commit

‚ùå **NEVER commit from worktrees:**
- `.cursor/plans/` directory (it's a symlink)
- Other agents' working directories
- Shared output directories (`eval/`, `gene/`, `scenarios/`)

### Commit Commands

```bash
# Review your changes
git status
git diff

# Stage ONLY your code changes
git add config/new_config.yaml
git add tools/new_tool.py

# Commit with proper message
git commit -m "‚ú® feat: add new feature implementation"

# Push to your feature branch
git push origin feat/phase-name
```

## Task Dependencies

**ALWAYS** check task dependencies before starting:

- ‚úÖ **Can start**: Task dependencies are completed (`[DONE]`)
- ‚è∏Ô∏è **Wait**: Task dependencies are in progress (`[IN PROGRESS]`)
- üö´ **Blocked**: Task dependencies not started

Example:
```markdown
### Task 2.1: Implement Core Detection Module [ ]
**Dependencies:** Task 1.4 (abnormal config)
```

If Task 1.4 is not `[DONE]`, **DO NOT** start Task 2.1. Choose another available task.

## Parallel Work Guidelines

### Safe to Work in Parallel

‚úÖ Tasks that create **different files**:
- Agent1: `config/dataset_a.yaml` (new file)
- Agent2: `config/dataset_b.yaml` (new file)
- Agent3: `tools/new_tool.py` (new file)

### NOT Safe to Work in Parallel

‚ùå Tasks that modify **the same file**:
- Multiple agents editing `main_module.py`
- Multiple agents editing `core_pipeline.py`

**Rule**: Only ONE agent should work on a single file at a time.

## File Conflict Prevention

### Before Editing a File

1. Check the plan to see if another agent is working on tasks that touch this file
2. If unclear, add a note to the plan:
   ```markdown
   **Agent1 Note**: Currently editing python_pipeline.py lines 76-126 for Task 3.1
   ```

### Merge Strategy

When your task is complete:

1. Push your feature branch
2. If working on shared files (like `python_pipeline.py`), coordinate merges sequentially
3. Pull and test after other agents merge related changes

## Worktree-Specific Commands

### Environment Activation

```bash
# Already handled by worktree setup
# Each worktree has isolated .venv/ from `uv sync`

# Run commands with uv
uv run python script.py
uv run pytest tests/
uv tool run ruff check .
```

### Verifying Setup

```bash
# Check symlink is working
ls -la .cursor/plans/  # Should show symlink to root worktree

# Check environment is isolated
which python  # Should point to .venv in your worktree

# Check dependencies installed
uv run python -c "print('Environment ready!')"
```

## Communication Through Plan

### Adding Notes

Add notes to task sections for important decisions:

```markdown
### Task 2.1: Implement Core Detection Module [IN PROGRESS - Agent3 - 2025-11-02 15:00]

**Agent3 Note**: Using z-score threshold of 2.5 as specified in config.
Implemented calculate_speed_profile() with haversine distance calculation.
```

### Blocking Issues

If blocked, update task status:

```markdown
### Task 3.2: Add Cross-Dataset Validation [BLOCKED - Missing BJUT dataset symlink]

**Agent4 Note**: Waiting for Task 1.1 to complete. Dataset path doesn't exist yet.
```

## Quick Validation Commands

Before claiming task:
```bash
grep "Task X.Y:" .cursor/plans/*.plan.md | head -1
```

Before editing file:
```bash
grep "filename.py" .cursor/plans/*.plan.md | grep "IN PROGRESS"
```

Before committing:
```bash
git status && uv tool run ruff check .
```

Before merging:
```bash
uv tool run ruff check . && uv run pytest
```

## Worktree Verification

On first login to worktree, verify automatic setup completed:

```bash
# 1. Check symlink was created by setup script
ls -la .cursor/plans/  # Should be symlink to root repo

# 2. Verify symlink target
readlink .cursor/plans/

# 3. Check setup log for any issues
tail -20 .cursor/worktree-setup.log

# 4. Check dependencies installed
uv run python -c "print('OK')"

# 5. Check you're on correct branch
git branch --show-current

# 6. Check parent commits
git log --oneline -5
```

## Troubleshooting Worktree Setup

If `.cursor/plans` symlink is missing:

**Check Cursor's setup output:**
- Open "Output" panel (View ‚Üí Output)
- Select "Worktrees Setup" from dropdown
- Look for errors during worktree creation

**Check setup log in worktree:**
```bash
cat .cursor/worktree-setup.log
```

**Manually run setup script:**
```bash
cd worktree-path
bash .cursor/setup-worktree-unix.sh
```

**Verify configuration:**
```bash
# Check worktrees.json exists
cat .cursor/worktrees.json

# Check setup script exists
ls -la .cursor/setup-worktree-unix.sh
```

If issues persist, contact the user or check the root repository's `.cursor/` configuration.

## Troubleshooting Plan File Synchronization

### Issue: Plan updates not visible across agents

**Symptom**: Agent updates plan in worktree, but other agents/root don't see changes

**Cause**: Cursor file buffer caching - the editor caches file contents and doesn't auto-reload

**Solution**:

1. **Verify symlink is working** (files should be identical):
```bash
# Check symlink exists
ls -la .cursor/plans/

# Verify same inode (proves it's the same file)
stat -L .cursor/plans/*.plan.md | grep Inode
stat -L /path/to/root/.cursor/plans/*.plan.md | grep Inode

# Diff should show no differences
diff .cursor/plans/*.plan.md /path/to/root/.cursor/plans/*.plan.md
```

2. **Force Cursor to reload** the plan file:
   - **Close the file** in all worktree windows
   - **Reopen it** - Cursor will read from disk
   - Or use **"Revert File"** command (Ctrl+K R)
   - Or **restart Cursor** in that worktree

3. **Best practice for agents**:
   - Always **close plan file** after updating
   - **Reopen** before reading to get latest changes
   - Use command line to verify: `cat .cursor/plans/*.plan.md | grep "Task X.Y"`

### Verification Commands

```bash
# Verify symlink is working (in worktree)
readlink .cursor/plans/  # Should point to root repo

# Check if file is same as root
diff -q .cursor/plans/*.plan.md $(readlink .cursor/plans/)/*.plan.md && echo "‚úì Symlink working"

# Force read from disk (bypasses editor cache)
cat .cursor/plans/*.plan.md | grep "IN PROGRESS"
```

**Remember**: The symlink works at the **filesystem level**. Cursor's editor needs to be told to reload the file from disk.

## Example Workflow

### Agent Starting Work

```bash
# 1. In your worktree
cd /path/to/PROJECT-worktree

# 2. Read the plan
cat .cursor/plans/*.plan.md

# 3. Find available task (e.g., Task 1.2)

# 4. Update plan status to [IN PROGRESS - Agent1 - Date]
# (Edit and save the plan file)

# 5. Start working on subtasks
# - Create or modify files as specified in task
# - Check subtasks as complete in plan

# 6. Test your changes
uv tool run ruff check .

# 7. Commit your code
git add changed_files
git commit -m "‚ú® feat: implement task X.Y"

# 8. Mark task as DONE in plan
# (Edit and save the plan file)

# 9. Push your branch
git push origin feat/phase-name
```

## Rules Summary

1. ‚úÖ **ALWAYS** read the plan before starting work
2. ‚úÖ **ALWAYS** update task status when starting/completing tasks
3. ‚úÖ **ALWAYS** save the plan file (changes are instant via symlink)
4. ‚ùå **NEVER** commit `.cursor/plans/` from worktrees (it's a symlink)
5. ‚úÖ **ONLY** commit your code changes from your worktree branch
6. ‚úÖ **ALWAYS** check task dependencies before starting
7. ‚úÖ **ALWAYS** verify no other agent is editing the same file
8. ‚úÖ **ALWAYS** use `uv run` for Python commands
9. ‚úÖ **ALWAYS** follow git commit message conventions with gitmojis
10. ‚ùå **NEVER** force push or modify other agents' branches
